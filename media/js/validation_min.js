/**
 * @package     Joomla.Site
 * @subpackage  com_batensteinform
 *
 * @copyright   Copyright (C) 2025 Scouting Batenstein. All rights reserved.
 * @license     GNU General Public License version 2 or later; see LICENSE.txt
 */
var birthdateValidationTimeout,cachedFormData=null,cacheTimestamp=0;function getLanguageString(e){return void 0!==window.VALIDATION_TRANSLATIONS&&window.VALIDATION_TRANSLATIONS[e]?window.VALIDATION_TRANSLATIONS[e]:{COM_BATENSTEINFORM_ERROR_PHONE_REQUIRED:"Phone number is required",COM_BATENSTEINFORM_ERROR_PHONE_INVALID_CHARS:"Phone number may only contain digits, spaces, dashes and +",COM_BATENSTEINFORM_ERROR_PHONE_INVALID_FORMAT:"Invalid Dutch phone number. Use a valid mobile (06) or landline number.",COM_BATENSTEINFORM_ERROR_EMAIL_REQUIRED:"Email address is required",COM_BATENSTEINFORM_ERROR_EMAIL_SINGLE_AT:"Email address must contain exactly one @",COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_EMPTY:"Email address must contain text before the @",COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_TOO_LONG:"The part before @ may be maximum 64 characters long",COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_INVALID_CHARS:"Invalid character in email address before @",COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_DOT_POSITION:"Email address may not start or end with a dot",COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_CONSECUTIVE_DOTS:"Email address may not contain consecutive dots",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_EMPTY:"Email address must contain a domain after @",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_TOO_LONG:"Domain name may be maximum 253 characters long",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_NO_DOT:"Domain name must contain at least one dot",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_INVALID_POSITION:"Domain name may not start or end with a dot or dash",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_EMPTY_LABEL:"Domain name may not contain empty parts",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_LABEL_TOO_LONG:"Each part of domain name may be maximum 63 characters long",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_INVALID_CHARS:"Domain name may only contain letters, digits and dashes",COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_LABEL_HYPHEN:"Parts of domain name may not start or end with a dash",COM_BATENSTEINFORM_ERROR_EMAIL_TLD_INVALID:"Top-level domain must contain minimum 2 letters",COM_BATENSTEINFORM_ERROR_EMAIL_TYPO_SUGGESTION:"Did you possibly mean %s?",COM_BATENSTEINFORM_ERROR_EMERGENCY_CONSENT:"Emergency treatment consent is required.",COM_BATENSTEINFORM_IBAN_ERROR_INVALID_FORMAT:"Invalid IBAN format. Please enter a valid Dutch IBAN.",COM_BATENSTEINFORM_FORM_REQUIRED_FIELDS:"Please fill in the required field:",COM_BATENSTEINFORM_PHONE_NUMBER_LABEL:"Phone number",COM_BATENSTEINFORM_EMAIL_ADDRESS_LABEL:"Email address"}[e]||e}function validateBirthdateAndSection(){var e,t=document.querySelector("#jform_birth_date"),a=document.querySelector("input[name='jform[scout_section]']:checked");return!(t&&a&&(t=t.value,a=a.value,t)&&a&&(t=calculateAge(t),console.log("Calculated age:",t),null!==t)&&(e=getLanguageString("COM_BATENSTEINFORM_SECTION_ALERT_PREFIX").replace("%s",t)+getLanguageString("COM_BATENSTEINFORM_SECTION_ALERT_DOES_NOT_MATCH"),"welpen"===a&&(t<7||11<=t)?(alert(e+getLanguageString("COM_BATENSTEINFORM_SECTION_WELPEN_ALERT")),1):"scouts"===a&&(t<11||15<=t)?(alert(e+getLanguageString("COM_BATENSTEINFORM_SECTION_SCOUTS_ALERT")),1):"explorers"===a&&(t<15||18<=t)?(alert(e+getLanguageString("COM_BATENSTEINFORM_SECTION_EXPLORERS_ALERT")),1):("stam"===a||"plus"===a||"sikas"===a)&&t<18&&(alert(e+getLanguageString("COM_BATENSTEINFORM_SECTION_STAM_ALERT")),1)))}function validateEmergencyConsent(){var e=document.querySelector('[name="jform[emergency_treatment_consent]"]:checked');return!(!e||"No"===e.value)||(confirm(getLanguageString("COM_BATENSTEINFORM_ERROR_EMERGENCY_CONSENT")),!1)}function debouncedAutoSelection(){birthdateValidationTimeout&&clearTimeout(birthdateValidationTimeout),birthdateValidationTimeout=setTimeout(function(){var e=document.querySelector("#jform_birth_date");e&&null!==(e=calculateAge(e.value))&&(e<7?alert(getLanguageString("COM_BATENSTEINFORM_SECTION_ALERT_PREFIX").replace("%s",e)+getLanguageString("COM_BATENSTEINFORM_SECTION_ALERT_NO_COMBINATION")):autoSelectScoutSection(e))},500)}function validateCurrentPage(){var e=currentPage,t=!0,a=[];if(1==e){var n=document.querySelector("input[name='jform[scout_section]']:checked"),n=n?n.value:null,a=["first_name","calling_name","last_name","address","postal_code_city","birth_date","birth_place","scout_section"];if("welpen"!==n&&"scouts"!==n&&"explorers"!==n||(a=a.concat(["parent1_name","parent1_phone_number","parent1_email_address"])),"welpen"!==n&&(a.push("email_address"),"explorers"!==n&&"stam"!==n&&"sikas"!==n&&"plus"!==n||a.push("phone_number")),!validateBirthdateAndSection())return!1}else if(2==e)a=["images_website","images_social","images_newspaper"];else if(3==e){if(a=["can_swim","emergency_contact_name","emergency_contact_relation","emergency_contact_phone","special_health_care","medication","allergies","diet","health_insurance","policy_number","gp_name","gp_address","gp_phone","emergency_treatment_consent"],!validateEmergencyConsent())return!1}else 4==e&&(a=["iban","account_name"]);for(var r=0;r<a.length;r++){var i=a[r],o=document.querySelector('[name="jform['+i+']"]');if(!(o=o||document.querySelector('[name="jform['+i+']"]:checked'))||!o.value||""===o.value.trim()){t=!1,i=getFieldLabel(i);alert(getLanguageString("COM_BATENSTEINFORM_FORM_REQUIRED_FIELDS")+" "+i),o&&o.focus();break}}return t}function integrateBatensteinValidation(){var e=window.validateCurrentPage;window.validateCurrentPage=function(){var n=!e||e();return document.querySelectorAll('input[name*="phone"]:not([type="hidden"]), input[name*="Phone"]:not([type="hidden"])').forEach(function(e){var t,a=e.value.trim();return""===a||(a=validateDutchPhoneNumber(a)).isValid?void 0:(n=!1,t=getFieldLabel(e.name.replace("jform[","").replace("]",""))||getLanguageString("COM_BATENSTEINFORM_PHONE_NUMBER_LABEL"),alert(t+": "+a.errors.join(", ")),e.focus(),!1)}),document.querySelectorAll('input[name*="email"]:not([type="hidden"]), input[name*="Email"]:not([type="hidden"])').forEach(function(e){var t,a=e.value.trim();return""===a||(a=validateEmailAddress(a)).isValid?void 0:(n=!1,t=getFieldLabel(e.name.replace("jform[","").replace("]",""))||getLanguageString("COM_BATENSTEINFORM_EMAIL_ADDRESS_LABEL"),alert(t+": "+a.errors.join(", ")),e.focus(),!1)}),document.querySelectorAll('input[name*="iban"]:not([type="hidden"]), input[name*="iban"]:not([type="hidden"])').forEach(function(e){var t,a=e.value.trim();return""===a||(a=validateIbanWithChecksum(a)).isValid?void 0:(n=!1,t=getFieldLabel(e.name.replace("jform[","").replace("]",""))||getLanguageString("COM_BATENSTEINFORM_IBAN_LABEL"),alert(t+": "+a.errors.join(", ")),e.focus(),!1)}),n}}function addStoredDataToForm(){var n,r=document.getElementById("batenstein-form");return r?((n=getFormDataFromStorage())?(r.querySelectorAll('input[data-stored-field="true"]').forEach(function(e){e.remove()}),Object.keys(n).forEach(function(e){var t,a=n[e];!a||"option"===e||"task"===e||"page"===e||e.includes("token")||(t=r.querySelector('[name="'+e+'"]'))&&t.value||((t=document.createElement("input")).type="hidden",t.name=e,t.value=a,t.setAttribute("data-stored-field","true"),r.appendChild(t))})):console.warn("No stored form data found"),!0):(console.error("Form not found"),!1)}function debugFormData(){var e=document.getElementById("batenstein-form");if(e){console.log("=== FORM SUBMISSION DEBUG ===");var t,a,n=getFormDataFromStorage(),e=(console.log("Stored data in sessionStorage:",n),new FormData(e)),r={};for(t of e.entries())r[t[0]]=t[1];console.log("Current form data (will be submitted):",r),n&&(a=[],Object.keys(n).forEach(function(e){!r[e]&&n[e]&&a.push(e)}),0<a.length)&&console.warn("Fields in storage but not in current form:",a),console.log("=== END DEBUG ===")}else console.error("Form not found")}function saveFormData(){var n={},e=document.getElementById("batenstein-form");if(e){try{var t=sessionStorage.getItem(FORM_STORAGE_KEY);t&&(n=JSON.parse(t))}catch(e){console.warn("Could not load existing form data from sessionStorage:",e),n={}}e.querySelectorAll("input, select, textarea").forEach(function(e){var t,a=e.name;a&&("radio"===e.type||"checkbox"===e.type?e.checked&&(n[a]=e.value):"date"===e.type||e.hasAttribute("data-custom-date")?""!==e.value?(t=e.hasAttribute("data-custom-date")?e.getAttribute("data-iso-value")||formatDateForStorage(e.value):formatDateForInput(e.value))&&(n[a]=t):n[a]:""===e.value&&void 0===n[a]||(n[a]=e.value))});try{sessionStorage.setItem(FORM_STORAGE_KEY,JSON.stringify(n)),invalidateFormDataCache()}catch(e){console.warn("Could not save form data to sessionStorage:",e)}}}function restoreFormData(){try{var r,a,n,e,i=getFormDataFromStorage();i&&((r=document.getElementById("batenstein-form"))?(a=r.querySelector('input[name="jform[birth_date]"]'),n=i["jform[birth_date]"],a&&n&&(e=formatDateForInput(n))&&("date"===a.type&&setupCustomDateFormat(a),"text"===a.type&&a.hasAttribute("data-custom-date")?(a.value=formatDateForDisplay(e),a.setAttribute("data-iso-value",e)):a.value=e,a.setAttribute("data-restored","true")),Object.keys(i).forEach(function(e){var t,a,n=i[e];n&&"jform[birth_date]"!==e&&(t=r.querySelector('[name="'+e+'"]'))&&("radio"===t.type?(a=r.querySelector('[name="'+e+'"][value="'+n+'"]'))&&(a.checked=!0,"jform[scout_section]"===e&&a.setAttribute("data-user-selected","true"),e=new Event("change",{bubbles:!0}),a.dispatchEvent(e)):"checkbox"===t.type?t.checked=n===t.value:"date"===t.type?(a=formatDateForInput(n))&&(setupCustomDateFormat(t),"text"===t.type&&t.hasAttribute("data-custom-date")?(t.value=formatDateForDisplay(a),t.setAttribute("data-iso-value",a)):t.value=a,t.setAttribute("data-restored","true")):t.value=n)}),setTimeout(function(){var e,t=r.querySelector('input[name="jform[scout_section]"]:checked');t&&(e=new Event("change",{bubbles:!0}),t.dispatchEvent(e));['input[name="jform[can_swim]"]:checked','input[name="jform[special_health_care]"]:checked','input[name="jform[medication]"]:checked','input[name="jform[allergies]"]:checked','input[name="jform[diet]"]:checked'].forEach(function(e){var t,e=r.querySelector(e);e&&(t=new Event("change",{bubbles:!0}),e.dispatchEvent(t))}),a&&n&&(t=formatDateForInput(n),e=a.value,a.hasAttribute("data-custom-date")?a.getAttribute("data-iso-value")!==t:e!==t)&&(console.warn("Birth date was overwritten! Restoring again..."),a.hasAttribute("data-custom-date")?(a.value=formatDateForDisplay(t),a.setAttribute("data-iso-value",t)):a.value=t)},150)):console.warn("Form not found during restoration"))}catch(e){console.warn("Could not restore form data from sessionStorage:",e)}}function formatDateForDisplay(e){var t,a;return e&&"string"==typeof e?(t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/))?(a=t[1],t[3]+"-"+t[2]+"-"+a):e:""}function formatDateForStorage(e){if(!e||"string"!=typeof e)return"";var t=e.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(t){var a=t[1].padStart(2,"0"),n=t[2].padStart(2,"0"),t=t[3],r=new Date(t,n-1,a);if(!isNaN(r.getTime())&&r.getDate()==parseInt(a)&&r.getMonth()==parseInt(n)-1&&r.getFullYear()==parseInt(t))return a+"-"+n+"-"+t}return e}function formatDateForInput(e){if(e&&"string"==typeof e){var t=e.trim(),a=t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(a){var n=a[1].padStart(2,"0"),r=a[2].padStart(2,"0"),i=a[3],o=new Date(i,r-1,n);if(!isNaN(o.getTime())&&o.getDate()==parseInt(n)&&o.getMonth()==parseInt(r)-1&&o.getFullYear()==parseInt(i))return n+"-"+r+"-"+i}if(/^\d{4}-\d{2}-\d{2}$/.test(t))if(o=new Date(t+"T00:00:00"),!isNaN(o.getTime()))return(a=t.split("-"))[2]+"-"+a[1]+"-"+a[0];a=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(a){var n=a[1].padStart(2,"0"),r=a[2].padStart(2,"0"),i=a[3];if(o=new Date(i,r-1,n),!isNaN(o.getTime())&&o.getDate()==parseInt(n)&&o.getMonth()==parseInt(r)-1&&o.getFullYear()==parseInt(i))return n+"-"+r+"-"+i}if(o=new Date(t),!isNaN(o.getTime()))return i=o.getFullYear(),r=String(o.getMonth()+1).padStart(2,"0"),(n=String(o.getDate()).padStart(2,"0"))+"-"+r+"-"+i;console.warn("Could not format date string:",e)}return null}function setupCustomDateFormat(a){var e;function t(){var e,t=a.value.trim();t&&((e=formatDateForStorage(t))&&e!==t&&a.setAttribute("data-euro-value",e),t&&!/^(\d{1,2})-(\d{1,2})-(\d{4})$/.test(t)?a.classList.add("invalid-date"):a.classList.remove("invalid-date"))}a&&"date"===a.type&&(a.type="text",a.placeholder="DD-MM-YYYY",a.pattern="\\d{1,2}-\\d{1,2}-\\d{4}",a.setAttribute("data-custom-date","true"),a.value&&/^\d{4}-\d{2}-\d{2}$/.test(a.value)&&(a.value=formatDateForDisplay(a.value)),a.addEventListener("input",function(){clearTimeout(e),e=setTimeout(t,500)}),a.addEventListener("blur",t),a.addEventListener("input",function(e){var t=e.target.value.replace(/[^\d]/g,""),a="";1<=t.length&&(a=t.substring(0,2)),3<=t.length&&(a+="-"+t.substring(2,4)),5<=t.length&&(a+="-"+t.substring(4,8)),a!==e.target.value&&t.length<=8&&(e.target.value=a)}))}function initializeAutoSave(){var e;function t(){clearTimeout(e),e=setTimeout(function(){saveFormData()},1e3)}document.addEventListener("change",function(e){e.target.closest("#batenstein-form")&&t()}),document.addEventListener("input",function(e){e.target.closest("#batenstein-form")&&t()}),window.addEventListener("beforeunload",function(){saveFormData()})}function clearStoredFormData(){try{sessionStorage.removeItem(FORM_STORAGE_KEY),invalidateFormDataCache()}catch(e){console.warn("Could not clear form data from sessionStorage:",e)}}function nextPage(){saveFormData(),currentPage<totalPages&&(window.location.href=NEXT_PAGE_URL+"&page="+(currentPage+1))}function previousPage(){saveFormData(),1<currentPage&&(window.location.href=NEXT_PAGE_URL+"&page="+(currentPage-1))}function populateReviewContent(){var e,t,a=document.getElementById("review-content");a?(e="",e+=generateReviewSection("Personal Information",["first_name","calling_name","name_prefix","last_name","address","postal_code_city","birth_date","birth_place","scout_section"]),(t=getFieldValue("scout_section",!0))&&"welpen"!==t&&(e+=generateReviewSection("Personal Contact",["phone_number","email_address"])),"welpen"!==t&&"scouts"!==t&&"explorers"!==t||(e+=generateReviewSection("Parent/Guardian 1",["parent1_name","parent1_phone_number","parent1_email_address"]),(t=getFieldValue("parent2_name"))&&""!==t.trim()&&(e+=generateReviewSection("Parent/Guardian 2",["parent2_name","parent2_phone_number","parent2_email_address"]))),e=(e=(e+=generateReviewSection("Image/Video Permissions",["images_website","images_social","images_newspaper"]))+generateReviewSection("Health Information",["can_swim","swim_diplomas","emergency_contact_name","emergency_contact_relation","emergency_contact_phone","special_health_care","special_health_care_details","medication","medication_details","allergies","allergies_details","diet","diet_details","health_insurance","policy_number","gp_name","gp_address","gp_phone","dentist_name","dentist_address","dentist_phone","emergency_treatment_consent"]))+generateReviewSection("Payment Information",["iban","account_name","sign_date"]),(t=getFieldValue("comments"))&&""!==t.trim()&&(e+=generateReviewSection("Comments",["comments"])),a.innerHTML=e):console.error("Review container not found")}function generateReviewSection(e,t){var r='<div class="review-section"><h3 class="review-section-title">'+e+'</h3><div class="review-fields">';return t.forEach(function(e){var t,a,n=getFieldValue(e,-1!==["scout_section","images_website","images_social","images_newspaper","can_swim","special_health_care","medication","allergies","diet","emergency_treatment_consent"].indexOf(e));"swim_diplomas"===e&&"Yes"!==getFieldValue("can_swim",!0)||"special_health_care_details"===e&&"Yes"!==getFieldValue("special_health_care",!0)||"medication_details"===e&&"Yes"!==getFieldValue("medication",!0)||"allergies_details"===e&&"Yes"!==getFieldValue("allergies",!0)||"diet_details"===e&&"Yes"!==getFieldValue("diet",!0)||n&&""!==n.trim()&&(t=getFieldLabel(e),a=n,"undefined"!=typeof TRANSLATIONS&&TRANSLATIONS[n]&&(a=TRANSLATIONS[n]),(e.includes("details")||"comments"===e||e.includes("address"))&&(a=a.replace(/\n/g,"<br>")),r+='<div class="review-field" data-field="'+e+'"><span class="review-field-label">'+t+':</span><span class="review-field-value"'+("emergency_treatment_consent"===e&&"No"===n?' style="color: #d9534f; font-weight: bold;"':"")+">"+a+"</span></div>")}),r+="</div></div>"}function setupJoomlaSubmitButton(){var t=window.Joomla?window.Joomla.submitbutton:null;window.Joomla||(window.Joomla={}),window.Joomla.submitbutton=function(e){"form.cancel"==e?(window.Joomla.submitform&&window.Joomla.submitform(e,document.getElementById("batenstein-form")),clearStoredFormData()):"form.nextPage"==e?validateCurrentPage()&&nextPage():"form.previousPage"==e?previousPage():"form.save"==e?(saveFormData(),document.formvalidator&&document.formvalidator.isValid(document.getElementById("batenstein-form"))&&addStoredDataToForm()&&(window.Joomla.submitform&&window.Joomla.submitform(e,document.getElementById("batenstein-form")),clearStoredFormData())):t&&t(e)}}function togglePersonalContact(){var e=document.querySelector("input[name='jform[scout_section]']:checked"),e=e?e.value:null,t=document.getElementById("personal_contact"),a=document.getElementById("personal_contact_note"),t=("scouts"===e||"explorers"===e||"stam"===e||"sikas"===e||"plus"===e?(t&&(t.style.display="block"),a&&(a.style.display="block")):(t&&(t.style.display="none"),a&&(a.style.display="none")),'<span class="star" aria-hidden="true">&nbsp;*</span>'),a=document.getElementById("jform_email_address-lbl"),a=(a&&("scouts"===e||"explorers"===e||"stam"===e||"sikas"===e||"plus"===e?-1===a.innerHTML.indexOf(t)&&(a.innerHTML=a.innerHTML+t):a.innerHTML=a.innerHTML.replace(t,"")),document.getElementById("jform_phone_number-lbl"));a&&("explorers"===e||"stam"===e||"sikas"===e||"plus"===e?(a.innerHTML=a.innerHTML.replace(t,""),-1===a.innerHTML.indexOf(t)&&(a.innerHTML=a.innerHTML+t)):a.innerHTML=a.innerHTML.replace(t,""))}function toggleParentContact(){var e=document.querySelector("input[name='jform[scout_section]']:checked"),e=e?e.value:null,t=document.getElementById("parent1_fieldset"),a=document.getElementById("parent2_fieldset");"welpen"===e||"scouts"===e||"explorers"===e?(t&&(t.style.display="block"),a&&(a.style.display="block")):(t&&(t.style.display="none"),a&&(a.style.display="none"))}function setupHealthConditionalFields(){document.querySelectorAll("input[name='jform[can_swim]']").forEach(function(e){e.addEventListener("change",function(){var e=document.getElementById("swim_diplomas_container");e&&("Yes"===this.value?e.style.display="block":e.style.display="none")})}),document.querySelectorAll("input[name='jform[special_health_care]']").forEach(function(e){e.addEventListener("change",function(){var e=document.getElementById("special_health_care_details_container");e&&("Yes"===this.value?e.style.display="block":e.style.display="none")})}),document.querySelectorAll("input[name='jform[medication]']").forEach(function(e){e.addEventListener("change",function(){var e=document.getElementById("medication_details_container");e&&("Yes"===this.value?e.style.display="block":e.style.display="none")})}),document.querySelectorAll("input[name='jform[allergies]']").forEach(function(e){e.addEventListener("change",function(){var e=document.getElementById("allergies_details_container");e&&("Yes"===this.value?e.style.display="block":e.style.display="none")})});document.querySelectorAll("input[name='jform[diet]']").forEach(function(e){e.addEventListener("change",function(){var e=document.getElementById("diet_details_container");e&&("Yes"===this.value?e.style.display="block":e.style.display="none")})});["input[name='jform[can_swim]']:checked","input[name='jform[special_health_care]']:checked","input[name='jform[medication]']:checked","input[name='jform[allergies]']:checked","input[name='jform[diet]']:checked"].forEach(function(e){var t,e=document.querySelector(e);e&&(t=new Event("change",{bubbles:!0}),e.dispatchEvent(t))})}function initializeBatensteinForm(){initializeCustomDateFields(),restoreFormData(),initializeBatensteinValidation(),integrateBatensteinValidation(),setupJoomlaSubmitButton(),initializeAutoSave();var a=document.querySelector("#jform_birth_date");a&&(a.addEventListener("input",function(){debouncedAutoSelection()}),a.addEventListener("change",function(){debouncedAutoSelection()}),a.addEventListener("blur",function(){birthdateValidationTimeout&&clearTimeout(birthdateValidationTimeout);var e=calculateAge(this.value);null!==e&&autoSelectScoutSection(e)}),setTimeout(function(){var e=a.value,t=new Date,t=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0");e&&e!==t&&null!==(t=calculateAge(e))&&autoSelectScoutSection(t)},250)),document.querySelectorAll("input[name='jform[scout_section]']").forEach(function(e){e.addEventListener("click",function(){setTimeout(function(){validateBirthdateAndSection()},100),togglePersonalContact(),toggleParentContact()}),e.addEventListener("change",function(){togglePersonalContact(),toggleParentContact()})}),togglePersonalContact(),toggleParentContact(),a&&a.value&&validateBirthdateAndSection(),setupHealthConditionalFields(),"undefined"!=typeof currentPage&&5===currentPage&&setTimeout(function(){populateReviewContent()},100)}function validateEmailAddress(e){var t={isValid:!1,formatted:"",errors:[]};if(e&&"string"==typeof e){e=e.trim();if(1!==(e.match(/@/g)||[]).length)t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_SINGLE_AT"));else{var a=e.split("@"),n=a[0],a=a[1];if(n&&0!==n.length)if(64<n.length)t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_TOO_LONG"));else if(/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+(\.[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+)*$/.test(n))if(n.startsWith(".")||n.endsWith("."))t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_DOT_POSITION"));else if(n.includes(".."))t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_CONSECUTIVE_DOTS"));else if(a&&0!==a.length)if(253<a.length)t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_TOO_LONG"));else if(a.includes("."))if(a.startsWith(".")||a.endsWith(".")||a.startsWith("-")||a.endsWith("-"))t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_INVALID_POSITION"));else{for(var r=a.split("."),i=0;i<r.length;i++){var o=r[i];if(0===o.length)return t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_EMPTY_LABEL")),t;if(63<o.length)return t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_LABEL_TOO_LONG")),t;if(!/^[a-zA-Z0-9-]+$/.test(o))return t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_INVALID_CHARS")),t;if(o.startsWith("-")||o.endsWith("-"))return t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_LABEL_HYPHEN")),t}var n=r[r.length-1];/^[a-zA-Z]{2,}$/.test(n)?(n={"gmial.com":"gmail.com","gmai.com":"gmail.com","yahooo.com":"yahoo.com","hotmial.com":"hotmail.com","outlok.com":"outlook.com"})[a.toLowerCase()]?(n=n[a.toLowerCase()],t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_TYPO_SUGGESTION").replace("%s",n))):(t.isValid=!0,t.formatted=e.toLowerCase()):t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_TLD_INVALID"))}else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_NO_DOT"));else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_DOMAIN_EMPTY"));else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_INVALID_CHARS"));else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_LOCAL_EMPTY"))}}else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_EMAIL_REQUIRED"));return t}function validateDutchPhoneNumber(e){var t={isValid:!1,formatted:"",type:"",errors:[]};if(e&&"string"==typeof e){var a=e.replace(/[\s\-\.\(\)]/g,"");if(/^[\+]?[0-9]+$/.test(a)){for(var n,r=[/^06[0-9]{8}$/,/^\+316[0-9]{8}$/,/^00316[0-9]{8}$/],i=[/^0(10|13|15|20|23|24|26|30|33|35|36|38|40|43|45|46|50|53|55|58|70|71|72|73|74|75|76|77|78|79)[0-9]{7}$/,/^\+31(10|13|15|20|23|24|26|30|33|35|36|38|40|43|45|46|50|53|55|58|70|71|72|73|74|75|76|77|78|79)[0-9]{7}$/,/^0031(10|13|15|20|23|24|26|30|33|35|36|38|40|43|45|46|50|53|55|58|70|71|72|73|74|75|76|77|78|79)[0-9]{7}$/],o=[/^0(111|113|114|115|117|118|161|162|164|165|166|167|168|172|174|180|181|182|183|184|186|187|222|223|224|226|227|228|229|251|252|255|294|297|299|313|314|315|316|317|318|320|321|342|343|344|345|346|347|348|411|412|413|416|418|475|478|481|485|486|487|488|492|493|495|497|498|499|511|512|513|514|515|516|517|518|519|521|522|523|524|525|527|528|529|541|543|544|545|546|547|548|561|562|566|571|572|573574|575|577|578|591|592|593|594|595|596|597|598|599)[0-9]{6}$/,/^\+31(111|113|114|115|117|118|161|162|164|165|166|167|168|172|174|180|181|182|183|184|186|187|222|223|224|226|227|228|229|251|252|255|294|297|299|313|314|315|316|317|318|320|321|342|343|344|345|346|347|348|411|412|413|416|418|475|478|481|485|486|487|488|492|493|495|497|498|499|511|512|513|514|515|516|517|518|519|521|522|523|524|525|527|528|529|541|543|544|545|546|547|548|561|562|566|571|572|573|574|575|577|578|591|592|593|594|595|596|597|598|599)[0-9]{6}$/,/^0031(111|113|114|115|117|118|161|162|164|165|166|167|168|172|174|180|181|182|183|184|186|187|222|223|224|226|227|228|229|251|252|255|294|297|299|313|314|315|316|317|318|320|321|342|343|344|345|346|347|348|411|412|413|416|418|475|478|481|485|486|487|488|492|493|495|497|498|499|511|512|513|514|515|516|517|518|519|521|522|523|524|525|527|528|529|541|543|544|545|546|547|548|561|562|566|571|572|573|574|575|577|578|591|592|593|594|595|596|597|598|599)[0-9]{6}$/],s=0;s<r.length;s++)if(r[s].test(a))return t.isValid=!0,t.type="mobile",a.startsWith("06")?t.formatted=a.substring(0,2)+"-"+a.substring(2):a.startsWith("+316")?(n="0"+a.substring(3),t.formatted=n.substring(0,2)+"-"+n.substring(2)):a.startsWith("00316")&&(n="0"+a.substring(4),t.formatted=n.substring(0,2)+"-"+n.substring(2)),t;for(var l,s=0;s<i.length;s++)if(i[s].test(a))return t.isValid=!0,t.type="landline",a.startsWith("0")?t.formatted=a.substring(0,3)+"-"+a.substring(3):a.startsWith("+31")?(l="0"+a.substring(3),t.formatted=l.substring(0,3)+"-"+l.substring(3)):a.startsWith("0031")&&(l="0"+a.substring(4),t.formatted=l.substring(0,3)+"-"+l.substring(3)),t;for(var u,s=0;s<o.length;s++)if(o[s].test(a))return t.isValid=!0,t.type="landline",a.startsWith("0")?t.formatted=a.substring(0,4)+"-"+a.substring(4):a.startsWith("+31")?(u="0"+a.substring(3),t.formatted=u.substring(0,4)+"-"+u.substring(4)):a.startsWith("0031")&&(u="0"+a.substring(4),t.formatted=u.substring(0,4)+"-"+u.substring(4)),t;t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_PHONE_INVALID_FORMAT"))}else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_PHONE_INVALID_CHARS"))}else t.errors.push(getLanguageString("COM_BATENSTEINFORM_ERROR_PHONE_REQUIRED"));return t}function setupPhoneValidation(a,n){var e;function t(){var e,t=a.value.trim();a.classList.remove("invalid-phone"),(n.textContent="")!==t&&((e=validateDutchPhoneNumber(t)).isValid?(a.classList.remove("invalid"),e.formatted!==t&&(a.value=e.formatted)):(a.classList.add("invalid-phone"),a.classList.add("invalid"),n.textContent=e.errors.join(", ")))}a&&(n||((n=document.createElement("div")).className="phone-validation-error",n.style.color="#d9534f",n.style.fontSize="0.875em",n.style.marginTop="5px",a.parentNode.appendChild(n)),a.addEventListener("input",function(){clearTimeout(e),e=setTimeout(t,800)}),a.addEventListener("blur",t),a.addEventListener("paste",function(){setTimeout(t,100)}))}function setupScoutSectionTracking(){var e=document.querySelectorAll("input[name='jform[scout_section]']");e.forEach(function(t){t.addEventListener("click",function(){this.setAttribute("data-user-selected","true"),e.forEach(function(e){e!==t&&e.removeAttribute("data-user-selected")})})})}function setupEmailValidation(a,n){var e;function t(){var e,t=a.value.trim();a.classList.remove("invalid-email"),(n.textContent="")!==t&&((e=validateEmailAddress(t)).isValid?(a.classList.remove("invalid"),e.formatted!==t&&(a.value=e.formatted)):(a.classList.add("invalid-email"),a.classList.add("invalid"),n.textContent=e.errors.join(", ")))}a&&(n||((n=document.createElement("div")).className="email-validation-error",n.style.color="#d9534f",n.style.fontSize="0.875em",n.style.marginTop="5px",a.parentNode.appendChild(n)),a.addEventListener("input",function(){clearTimeout(e),e=setTimeout(t,800)}),a.addEventListener("blur",t),a.addEventListener("paste",function(){setTimeout(t,100)}))}function setupIbanValidation(a,n){var e;function t(){var e,t=a.value.trim();a.classList.remove("invalid-iban"),(n.textContent="")!==t&&((e=validateIbanWithChecksum(t)).isValid?(a.classList.remove("invalid"),e.formatted!==t&&(emailField.value=e.formatted)):(a.classList.add("invalid-iban"),a.classList.add("invalid"),n.textContent=e.errors.join(", ")))}a&&(n||((n=document.createElement("div")).className="iban-validation-error",n.style.color="#d9534f",n.style.fontSize="0.875em",n.style.marginTop="5px",a.parentNode.appendChild(n)),a.addEventListener("input",function(){clearTimeout(e),e=setTimeout(t,800)}),a.addEventListener("blur",t),a.addEventListener("paste",function(){setTimeout(t,100)}))}function initializeCustomDateFields(){document.querySelectorAll('input[type="date"]').forEach(function(e){setupCustomDateFormat(e)})}function initializeBatensteinValidation(){['input[name="jform[phone_number]"]','input[name="jform[parent1_phone_number]"]','input[name="jform[parent2_phone_number]"]','input[name="jform[emergency_contact_phone]"]','input[name="jform[gp_phone]"]','input[name="jform[dentist_phone]"]'].forEach(function(e){e=document.querySelector(e);e&&setupPhoneValidation(e)}),['input[name="jform[email_address]"]','input[name="jform[parent1_email_address]"]','input[name="jform[parent2_email_address]"]'].forEach(function(e){e=document.querySelector(e);e&&setupEmailValidation(e)}),['input[name="jform[iban]"]'].forEach(function(e){e=document.querySelector(e);e&&setupIbanValidation(e)})}function getFormDataFromStorage(){var e=Date.now();if(cachedFormData&&"undefined"!=typeof CACHE_DURATION&&e-cacheTimestamp<CACHE_DURATION)return cachedFormData;try{var t=sessionStorage.getItem(FORM_STORAGE_KEY);if(t)return cachedFormData=JSON.parse(t),cacheTimestamp=e,cachedFormData}catch(e){console.warn("Could not retrieve form data from sessionStorage:",e)}return cachedFormData=null}function invalidateFormDataCache(){cachedFormData=null,cacheTimestamp=0}function getFieldValue(e,t){void 0===t&&(t=!1);var a=document.getElementById("batenstein-form");if(a){a=a.querySelector(t?'input[name="jform['+e+']"]:checked':'[name="jform['+e+']"]');if(a&&a.value)return a.value}t=getFormDataFromStorage();return t&&t["jform["+e+"]"]||""}function getFieldLabel(e){return"undefined"!=typeof FIELD_LABELS&&FIELD_LABELS[e]?FIELD_LABELS[e]:e}function validateDutchIban(e){e=e.replace(/\s/g,"");return!!(/^NL/.test(e.toUpperCase().substring(0,2))&&18===e.length&&/^\d{2}$/.test(e.substring(2,4))&&/^[A-Za-z]{4}$/.test(e.substring(4,8))&&/^\d{10}$/.test(e.substring(8,18)))}function validateIbanWithChecksum(e){var t={isValid:!1,formatted:"",errors:[]},e=e.toUpperCase().replace(/\s/g,"");if(!validateDutchIban(e))return{formatted:e,isValid:!1,errors:[getLanguageString("COM_BATENSTEINFORM_IBAN_ERROR_INVALID_FORMAT")]};for(var a=e.substring(4)+e.substring(0,4),n="",r=0;r<a.length;r++){var i=a[r];/[A-Z]/.test(i)?n+=(i.charCodeAt(0)-"A".charCodeAt(0)+10).toString():n+=i}for(var o=0,r=0;r<n.length;r++)o=(10*o+parseInt(n[r]))%97;return 1!==o&&t.errors.push(getLanguageString("COM_BATENSTEINFORM_IBAN_ERROR_INVALID_FORMAT")),t.isValid=1===o,t.formatted=e.toUpperCase(),t}function calculateAge(e){return!e||!e.includes("-")||!/^(\d{1,2})-(\d{1,2})-(\d{4})$/.test(e)||(e=e.split("-"),e=new Date(e[2],e[1]-1,e[0]),isNaN(e.getTime()))?null:(new Date).getFullYear()-e.getFullYear()}function autoSelectScoutSection(e){for(var t=document.getElementsByName("jform[scout_section]"),a=null,n=!1,r=0;r<t.length;r++)if(t[r].checked){a=t[r].value,t[r].hasAttribute("data-user-selected")&&(n=!0);break}if(!n){var i="";if(7<=e&&e<11)i="welpen";else if(11<=e&&e<15)i="scouts";else if(15<=e&&e<18)i="explorers";else if(18<=e){if("plus"===a||"sikas"===a)return;i="stam"}if(i&&i!==a){for(r=0;r<t.length;r++)t[r].checked=!1;for(r=0;r<t.length;r++)if(t[r].value===i){t[r].checked=!0,t[r].removeAttribute("data-user-selected");var o=new Event("change",{bubbles:!0});t[r].dispatchEvent(o);break}}}}document.addEventListener("DOMContentLoaded",function(){window.validationInitialized||(initializeBatensteinForm(),window.validationInitialized=!0)});